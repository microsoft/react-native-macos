parameters:
  build_type: ''

steps:
  - template: apple-tools-setup.yml

  - template: apple-install-dependencies.yml

  # Only set up our release environment if we're not doing a dry run
  - ${{ if ne( parameters['build_type'], 'dry-run') }}:
    - template: apple-release-setup.yml  

  # Extra steps needed for *-stable releases
  - ${{ if eq( parameters['build_type'], 'release') }}:
    - task: CmdLine@2
      displayName: Set next version
      inputs:
        script: |
          VERSION=$(node .ado/get-next-semver-version.js)
          echo "Set version: $VERSION"

    - task: CmdLine@2
      displayName: Set latest tag
      inputs:
        script: |
          LATEST=true
          echo "Set latest to: $LATEST"

    - task: CmdLine@2
      displayName: Prepare and tag package for release
      inputs:
        script: |
          set -eo pipefail
          if [[ -z "$VERSION" ]]; then
            VERSION=$(grep '"version"' package.json | cut -d '"' -f 4 | head -1)
            echo "Using the version from the package.json: $VERSION"
          fi
          node ./scripts/prepare-package-for-release.js -v "$VERSION" -l $LATEST

  - task: CmdLine@2
    displayName: NPM Publish
    inputs:
      script: |
        set -eo pipefail
        node ./scripts/publish-npm.js --${{ parameters.build_type }}
        npm publish --tag nightly --registry https://registry.npmjs.org/ --//registry.npmjs.org/:_authToken=$(npmAuthToken)
